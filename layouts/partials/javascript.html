{{ $devMode    := site.IsServer }}
{{ $jsMain     := "js/app.js" }}
{{ $jsOutput   := "js/app.js" }}
{{ $defines    := dict "CI_COMMIT_SHORT_SHA" (getenv "CI_COMMIT_SHORT_SHA" | default `""`)
  "process.env.RESET_APP_DATA_TIMER" `10`
  "process.env.DEBUG" `false`
  "process.env.NODE_ENV" `"development"` }}
{{ $devOpts    := dict "target" "es2020" "defines" $defines "targetPath" $jsOutput "sourceMap" "external" }}
{{ $prodOpts   := dict "target" "es2020" "defines" $defines "targetPath" $jsOutput "sourceMap" "external" "minify" true }}
{{ $jsOpts     := cond $devMode $devOpts $prodOpts }}
{{ $babelOpts  := dict "config" "babel.config.json" }}
{{ $js := resources.Get $jsMain | js.Build $jsOpts | babel $babelOpts }}
{{ $jq := site.Params.jquery }}
{{ $jqUrl := printf "https://code.jquery.com/jquery-%s.min.js" $jq.version }}

{{/* Load jQuery synchronously. Version/sha256 info is in config/_default/config.yaml. */}}
<script src="{{ $jqUrl }}" integrity="{{ $jq.sha_256 }}" crossorigin="anonymous"></script>

{{/* The docsearch.js lib requires this for some reason */}}
<script>
  global = globalThis;
</script>

{{ if $devMode }}
<script src="{{ $js.RelPermalink }}" defer></script>
{{ else }}
{{ $prodJs := $js | resources.Fingerprint "sha512" }}
<script src="{{ $prodJs.RelPermalink }}" integrity="{{ $prodJs.Data.Integrity }}" defer></script>
{{ end }}
